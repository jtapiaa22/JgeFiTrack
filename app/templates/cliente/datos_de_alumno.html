{% extends "base.html" %}
{% block contenido %}

<div class="container mt-4">

  <!-- üîπ T√≠tulo principal -->
  <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
    <h2 class="text-primary fw-bold mb-2">
      <i class="bi bi-clipboard2-pulse"></i> Mediciones de {{ alumno.nombre }}
    </h2>

    <!-- Grupo de botones alineados a la derecha -->
    <div class="d-flex gap-2 mt-2 mt-md-0">
      <a href="{{ url_for('cliente.medicion', alumno_id=alumno.id) }}" class="btn btn-outline-success" id="btn-agregar_medicion">
        <i class="bi bi-people"></i> Agregar Medici√≥n
      </a>
      <button id="btn-pdf" class="btn btn-outline-danger">
        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
      </button>
    </div>
  </div>


  <!-- üìÑ Exportar PDF -->
  <script>
  document.getElementById("btn-pdf").addEventListener("click", async function() {
    const graficos = localStorage.getItem("graficosPDF");
    const formData = new FormData();
    formData.append("graficos", graficos);

    const response = await fetch("{{ url_for('cliente.exportar_pdf', id=alumno.id) }}", {
      method: "POST",
      body: formData
    });

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Reporte_{{ alumno.nombre }}.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
  });
  </script>

  {% if mediciones %}
  <!-- =========================================================
       üìã TABLA DE MEDICIONES ‚Äî SCROLL LATERAL RESPONSIVE
  ========================================================== -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-0">

      <!-- üîπ Scroll horizontal real -->
      <div class="table-responsive custom-scroll">
        <table class="table table-striped table-hover align-middle text-center mb-0">
          <thead class="table-primary">
            <tr>
              <th>Fecha</th>
              <th>Peso (kg)</th>
              <th>Altura (cm)</th>
              <th>IMC</th>
              <th>Metabolismo Basal</th>
              <th>Grasa (%)</th>
              <th>M√∫sculo (%)</th>
              <th>Agua Corporal (%)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for m in mediciones %}
            <tr>
              <td>{{ m.fecha.strftime('%d/%m/%Y') }}</td>
              <td>{{ m.peso }}</td>
              <td>{{ m.altura }}</td>
              <td>{{ m.imc }}</td>
              <td>{{ m.metabolismo_basal }}</td>
              <td>{{ m.grasa_corporal }}</td>
              <td>{{ m.musculo }}</td>
              <td>{{ m.agua_corporal }}</td>
              <td>
                <div class="d-flex justify-content-center flex-wrap gap-1">
                  <a href="{{ url_for('cliente.editar_medicion', id_alumno=alumno.id, id_medicion=m.id) }}" class="btn btn-sm btn-success">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <a href="{{ url_for('cliente.eliminar_medicion', id_alumno=alumno.id, id_medicion=m.id) }}" 
                     class="btn btn-sm btn-danger" 
                     onclick="return confirm('¬øSeguro que deseas eliminar esta medici√≥n?');">
                    <i class="bi bi-trash"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

 {% if resumen %}
  {% set clase = {'positivo':'resumen-positivo','negativo':'resumen-negativo','neutral':'resumen-neutral'}[estado_progreso] %}
  {% set mensaje = {'positivo':'üí™ Excelente avance','negativo':'‚ö†Ô∏è Revisa tus resultados','neutral':'üíß En progreso estable'}[estado_progreso] %}

  <div id="resumen-progreso" class="container my-4">
    <div class="resumen-box {{ clase }} text-center p-4 shadow-sm rounded-3 mx-auto" style="max-width: 600px;">
      <h5 class="fw-bold mb-3">{{ mensaje }}</h5>
      <div>
        {% for cambio in resumen %}
          <p class="mb-1">{{ cambio }}</p>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}




  <!-- =========================================================
       üìä GR√ÅFICOS DE PROGRESO
  ========================================================== -->
  <h4 class="text-center mt-5 mb-4 fw-bold text-primary">
    <i class="bi bi-bar-chart-line"></i> Evoluci√≥n del Progreso
  </h4>

  <div class="container mb-4 text-center">
    <div class="card shadow-sm mb-4 p-3 bg-light-subtle" id="pan">
      <h5 class="text-center fw-semibold text-primary mb-3">
        <i class="bi bi-graph-up-arrow"></i> Peso (kg)
      </h5>
      <canvas id="grafico_peso" height="220"></canvas>
    </div>

    <div class="card shadow-sm mb-4 p-3 bg-light-subtle" id="pan">
      <h5 class="text-center fw-semibold text-primary mb-3">
        <i class="bi bi-heart-pulse"></i> √çndice de Masa Corporal (IMC)
      </h5>
      <canvas id="grafico_imc" height="220"></canvas>
    </div>

    <div class="card shadow-sm mb-4 p-3 bg-light-subtle" id="pan">
      <h5 class="text-center fw-semibold text-primary mb-3">
        <i class="bi bi-droplet-half"></i> Grasa Corporal (%)
      </h5>
      <canvas id="grafico_grasa" height="220"></canvas>
    </div>

    <div class="card shadow-sm mb-4 p-3 bg-light-subtle" id="pan">
      <h5 class="text-center fw-semibold text-primary mb-3">
        <i class="bi bi-lightning-charge"></i> M√∫sculo (%)
      </h5>
      <canvas id="grafico_musculo" height="220"></canvas>
    </div>

    <div class="card shadow-sm mb-4 p-3 bg-light-subtle" id="pan">
      <h5 class="text-center fw-semibold text-primary mb-3">
        <i class="bi bi-droplet"></i> Agua Corporal (%)
      </h5>
      <canvas id="grafico_agua" height="220"></canvas>
    </div>
  </div>

  <!-- =========================================================
       üìà DATA PARA CHART.JS
  ========================================================== -->
  <script>
    window.datosMediciones = {
      fechas: {{ fechas|tojson }},
      pesos: {{ pesos|tojson }},
      imcs: {{ imcs|tojson }},
      grasas: {{ grasas|tojson }},
      musculos: {{ musculos|tojson }},
      aguas: {{ aguas|tojson }}
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='js/graficos.js') }}"></script>

  {% else %}
  <!-- üî∏ Caso sin mediciones registradas -->
  <div class="alert alert-warning text-center mt-4">
    <i class="bi bi-exclamation-triangle"></i> No hay mediciones registradas para este alumno.
  </div>
  {% endif %}
</div>

{% endblock %}
